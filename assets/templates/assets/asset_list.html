{% extends 'base.html' %}
{% load humanize %}

{% block title %}Inventory Aset{% endblock %}
{% block subtitle %}Kelola database seluruh aset IT.{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <div>
        <span id="total-asset-count" class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill border border-primary-subtle d-inline-block">
            <i class="bi bi-box-seam me-1"></i> Total Data: {{ assets.paginator.count }} Unit
        </span>
    </div>
    
    <div class="d-flex gap-2 w-100 justify-content-md-end">
        <button type="button" class="btn btn-outline-success rounded-pill px-3 px-md-4 shadow-sm flex-grow-1 flex-md-grow-0" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-file-earmark-excel me-1"></i> Import
        </button>
        
        <a href="{% url 'asset_create' %}" class="btn btn-primary rounded-pill px-3 px-md-4 shadow-sm flex-grow-1 flex-md-grow-0">
            <i class="bi bi-plus-lg me-1"></i> Tambah
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-3">
        <form id="filter-form" method="get" action="." class="row g-2" 
              hx-get="{% url 'asset_list' %}?page=1" 
              hx-target="#asset-table-body" 
              hx-swap="innerHTML" 
              hx-push-url="true"
              hx-indicator="#asset-table-body"
              hx-trigger="change, submit, keyup delay:500ms from:input[name='q'], refreshTable from:body">
            
            <input type="hidden" name="sort" value="{{ sort_current }}">
            
            <div class="col-md-2">
                <select name="category" class="form-select border-0 bg-light fw-medium text-secondary">
                    <option value="">Semua Kategori</option>
                    {% for cat in kategori_list %}
                        <option value="{{ cat.id }}" {% if category_filter == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.nama }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <select name="location" class="form-select border-0 bg-light fw-medium text-secondary">
                    <option value="">Semua Lokasi</option>
                    {% for loc in lokasi_list %}
                        <option value="{{ loc.id }}" {% if location_filter == loc.id|stringformat:"s" %}selected{% endif %}>
                            {{ loc.nama }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <select name="status" class="form-select border-0 bg-light fw-medium text-secondary">
                    <option value="">Semua Status</option>
                    {% for code, label in status_choices %}
                        <option value="{{ code }}" {% if status_filter == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md">
                <div class="input-group">
                    <span class="input-group-text border-0 bg-light text-muted ps-3">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" name="q" value="{{ query|default:'' }}" 
                           class="form-control border-0 bg-light" 
                           placeholder="Cari nama, SN, user..." autocomplete="off">
                </div>
            </div>
        </form>
    </div>
</div>

<div id="asset-table-body" class="card border-0 shadow-sm overflow-hidden fade-in">
    {% include 'assets/asset_table_partial.html' %}
</div>

<div id="modal-container" class="modal fade" tabindex="-1" aria-hidden="true">
    <div id="modal-content" class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="importModalLabel">Import Data Aset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form action="{% url 'import_assets_excel' %}" method="post" enctype="multipart/form-data" hx-boost="false">
        {% csrf_token %}
        <div class="modal-body py-4">
          <p class="text-muted small mb-3">
             Upload file Excel (<b>.xlsx</b>) untuk menambahkan banyak data sekaligus. Pastikan header kolom sesuai dengan sistem.
          </p>
          
          <a href="{% url 'download_excel_template' %}" hx-boost="false" class="btn btn-sm btn-light border mb-4 rounded-pill">
              <i class="bi bi-download me-1"></i> Download Template Kosong
          </a>
          
          <div class="mb-2">
            <label for="excelFile" class="form-label fw-medium small">Pilih File Excel</label>
            <input class="form-control" type="file" id="excelFile" name="excel_file" accept=".xlsx, .xls" required>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-success rounded-pill px-4">
              <i class="bi bi-cloud-upload me-1"></i> Upload & Proses
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
    /* Style Blur saat Modal Aktif */
    body.modal-open .card, 
    body.modal-open .d-flex.justify-content-between {
        filter: blur(5px);
        transition: filter 0.3s ease;
        pointer-events: none;
    }
    .modal-backdrop.show {
        opacity: 0.5; 
        background-color: #000;
    }
    /* FIX 3: Tambahin #importModal biar pop-up nya gak ikut ngeblur */
    #modal-container, #importModal {
        filter: none !important;
        z-index: 1060;
    }
</style>

<script>
    // SCRIPT BERSIH:
    // Logic 'closeModal' SUDAH DIHAPUS dari sini (karena sudah pindah ke base.html)
    
    // Kita sisakan ini saja biar tooltip tetap jalan setelah filter/sort
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>
{% endblock %}