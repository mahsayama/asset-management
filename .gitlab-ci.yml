image: docker:24.0.5
services:
  - docker:24.0.5-dind

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  LATEST_TAG: $CI_REGISTRY_IMAGE:main

stages:
  - build
  - test
  - deploy

# --- STAGE 1: BUILD (Aman, gak berubah) ---
build_image:
  stage: build
  script:
    - echo "Login ke GitLab Registry..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - echo "Build Docker Image..."
    - docker build -t $IMAGE_TAG -t $LATEST_TAG .
    - echo "Push Image ke Registry..."
    - docker push $IMAGE_TAG
    - docker push $LATEST_TAG

# --- STAGE 2: UNIT TESTING (Perlu Service Postgres Sementara) ---
test_application:
  stage: test
  image: python:3.12-slim
  # Kita butuh service postgres buat testing di GitLab Runner
  services:
    - name: postgres:15
      alias: postgres
  variables:
    # Settingan DB Dummy buat Testing
    POSTGRES_DB: test_db
    POSTGRES_USER: runner
    POSTGRES_PASSWORD: password
    POSTGRES_HOST_AUTH_METHOD: trust
    # Kasih tau Django connect kemana
    DB_HOST: postgres
    DB_NAME: test_db
    DB_USER: runner
    DB_PASSWORD: password
  script:
    - apt-get update && apt-get install -y gcc libpq-dev  # Install driver di runner
    - pip install -r requirements.txt
    - python manage.py test

# --- STAGE 3: DEPLOY STAGING ---
deploy_staging:
  stage: deploy
  image: alpine:latest
  environment:
    name: staging
    url: http://$SSH_IP:8080
  before_script:
    - apk update && apk add openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - echo "Deploy ke STAGING Server..."
    - |
      ssh $SSH_USER@$SSH_IP "
        docker login registry.gitlab.com -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD;
        docker stop web-staging || true;
        docker rm web-staging || true;
        docker pull $IMAGE_TAG;
        
        # PERUBAHAN UTAMA DI SINI:
        # 1. Connect ke network yg sama dgn DB (--network asset-network)
        # 2. Inject Env Variable DB (-e ...)
        # 3. Gak pake -v sqlite lagi
        docker run -d -p 8080:8000 \
          --name web-staging \
          --network asset-network \
          -e DB_HOST=db-staging \
          -e DB_NAME=asset_db \
          -e DB_USER=mahsaserver \
          -e DB_PASSWORD=rahasia_staging \
          $IMAGE_TAG;
          
        docker exec web-staging python manage.py migrate;
        docker exec web-staging python manage.py collectstatic --noinput;
      "

# --- STAGE 4: DEPLOY PRODUCTION ---
deploy_production:
  stage: deploy
  image: alpine:latest
  when: manual
  allow_failure: false
  environment:
    name: production
    url: http://$SSH_IP
  before_script:
    - apk update && apk add openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - echo "Deploy ke PRODUCTION Server..."
    - |
      ssh $SSH_USER@$SSH_IP "
        docker login registry.gitlab.com -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD;
        docker stop web-production || true;
        docker rm web-production || true;
        docker pull $IMAGE_TAG;
        
        # CONFIG PROD JUGA SAMA:
        docker run -d -p 80:8000 \
          --name web-production \
          --network asset-network \
          -e DB_HOST=db-production \
          -e DB_NAME=asset_db \
          -e DB_USER=mahsaserver \
          -e DB_PASSWORD=rahasia_prod \
          $IMAGE_TAG;
          
        docker exec web-production python manage.py migrate;
        docker exec web-production python manage.py collectstatic --noinput;
      "